<!DOCTYPE html lang="en-US"> 
    <head>
        <title>
            My player
        </title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/fontawesome.min.css" integrity="sha384-wESLQ85D6gbsF459vf1CiZ2+rr+CsxRY0RpiF1tLlQpDnAgg6rwdsUF1+Ics2bni" crossorigin="anonymous">
        <script src="https://kit.fontawesome.com/4b97760acf.js" crossorigin="anonymous"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
            <div class="container-md" id="mySongList">My Song List
                <div class="container-md">
                    <ol></ol>
                </div>
                <ol></ol>
            <div class="container-md">
                <div id="currentplay"></div>
                <audio id="myplayer" preload="metadata"></audio>
            </div>
            <div class="container-md">
                <button class="btn btn-warning" onclick="myAudioPlayer.playPrevious()">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button type="button" class="btn btn-primary" id="playButton" onclick="myAudioPlayer.playSong()">
                    <i class="far fa-play-circle"></i>
                </button>
                <button class="btn btn-success" onclick="myAudioPlayer.playNext()">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="btn btn-danger" onclick="myAudioPlayer.muteSound()">
                    <i class="fas fa-volume-mute"></i>
                </button>
                <!-- #scrubber input type="range" min="0" max="100" value="0" id="time_slider" onchange="displayTime()"-->
                <i id="myvolume" class="fas fa-volume-up"></i><input type="range" min="0" max="100" value="50" onchange="myAudioPlayer.changeVolume(this.value)">
            </div>
        </div>
    </body>
    <script>

        class AudioPlayer {

            duration_sec = 0
            current_play_sec = 0
            trackIndex = 0
            myTrack = null
            audioElement = null
            songStarted = false
            songList = null

            constructor(myTrack) {

                this.myTrack = myTrack
                this.audioElement = document.getElementById("myplayer")

                this.loadSongMenu()
                this.trackAction()
            }

            loadSongMenu() {

                this.songList = document.getElementById("mySongList").children[0].children[0]
                for (let i = 0; i < this.myTrack.length; i++) {
                   this.songList.innerHTML += `<li><a id=${i}>${myTrack[i].split(".")[0]}</a></li>`
                   
                }
            }

            changeVolume(value) {
                this.audioElement.volume = value/100

                if (this.audioElement.volume == 0) {
                    document.getElementById("myvolume").setAttribute("class", "fas fa-volume-mute")
                } else {
                    document.getElementById("myvolume").setAttribute("class", "fas fa-volume-up")   
                }
            }

            displayTime() {
                document.getElementById("time_slider").value = parseInt((this.audioElement.currentTime/this.audioElement.duration) * 100)
            }

            loadSong() {
                if (!((this.trackIndex >= this.myTrack.length) || (this.trackIndex < 0))) {
                    this.songStarted = true 

                    this.audioElement.src = this.myTrack[this.trackIndex]
                    this.audioElement.volume = 0.5
                    this.audioElement.play()
 
                    this.changeColor(this.trackIndex)
                    
                    this.audioElement.onloadedmetadata = (event) => {
                        this.duration_sec = this.audioElement.duration
                        this.duration_sec = parseInt(this.duration_sec / 60) + ":" + parseInt(this.duration_sec % 60)
                    }
                    
                    this.audioElement.ontimeupdate = (event) => {
                        this.current_play_sec = this.audioElement.currentTime
                        document.getElementById("currentplay").innerHTML = "Current Playing: " + 
                            this.myTrack[this.trackIndex].split(".")[0] + 
                            "       " + "   " +  
                            parseInt(this.current_play_sec /60) + 
                            ":" + 
                            String(parseInt(this.current_play_sec % 60)).padStart(2, "0")  + 
                            " / " + this.duration_sec
                    }
                    
                    this.audioElement.onended = (event) => {
                        if (this.trackIndex < this.myTrack.length) {
                            this.songStarted = false
                            this.playNext()
                        }
                    }
                }
            }

            changeTrack(trackNumber) {
                this.songStarted = false
                this.trackIndex = trackNumber
            }

            playSong() {
                if (this.songStarted) {
                    this.pauseSong()

                } else {
                    this.loadSong()
                }
            }

            muteSound() {
                this.audioElement.muted = !this.audioElement.muted
            }

            playNext() {
                if (this.trackIndex >= this.myTrack.length - 1) {
                    console.log("Exceed")
                    this.trackIndex = 0

                } else {
                    this.songStarted= false
                    this.trackIndex++
                    this.playSong()
                }
            }

            playPrevious() {

                if (this.trackIndex < 0) {
                    console.log("No more")
                    this.trackIndex = 0

                } else {
                    this.songStarted = false
                    this.trackIndex--
                    this.playSong()

                }
            }

            pauseSong() {

                if (!this.audioElement.paused) {
                    document.getElementById("playButton").children[0].setAttribute("class", "far fa-pause-circle")
                    this.audioElement.pause()

                } else {
                    document.getElementById("playButton").children[0].setAttribute("class", "far fa-play-circle")
                    this.audioElement.play()
                }
            }

            changeColor(index) {
            
                for (let i = 0; i < this.songList.children.length; i++) {
                    this.songList.children[i].style.backgroundColor = "white"
                }

                if (index < this.songList.children.length) {
                    this.songList.children[index].style.backgroundColor = "red"
                }
            }

            trackAction() {
                let songMenu = document.getElementsByTagName("a")
        
                for (let i = 0; i < songMenu.length; i++) {
                    songMenu[i].onclick = function() {
                        myAudioPlayer.changeTrack(i)
                        myAudioPlayer.playSong()
                    }
                }
            }

        }

        let myTrack = [
            "time.flac",
            "one_last_kiss.flac",
            "桜流し (2021 Remastered).flac",
            "Merry Christmas Mr Lawrence - FYI.flac",
            "Come Back To Me.flac",
            "Prisoner Of Love.flac"
        ]
        
        let myAudioPlayer = new AudioPlayer(myTrack)

    </script>
</html>